package org.zaproxy.addon.naf.ui.exploit

import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material.*
import androidx.compose.material.MaterialTheme.typography
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Add
import androidx.compose.material.icons.filled.AddCircle
import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import kotlinx.coroutines.flow.asStateFlow
import org.zaproxy.addon.naf.component.ExploitComponent
import org.zaproxy.addon.naf.component.exploit.*
import org.zaproxy.addon.naf.ui.collectAsMutableState
import kotlin.reflect.KClass

@Composable
fun Exploit(
    component: ExploitComponent
) {

    val indexTabSelected = component.currentIndex.collectAsMutableState()
    val listTab = component.listExploitTabComponent

    Column {
        ScrollableTabRow(
            selectedTabIndex = indexTabSelected.value,
            modifier = Modifier.wrapContentWidth(),
            edgePadding = 10.dp
        ) {
            listTab.forEachIndexed { index, tab ->
                Tab(
                    selected = indexTabSelected.value == index,
                    onClick = {
                        indexTabSelected.value = index
                    }
                ) {
                    Column {
                        Text(tab.title)
                    }
                }
            }

            Tab(
                selected = false,
                onClick = {
                    listTab.add(StartTabComponent())
                    indexTabSelected.value = listTab.size - 1
                },
            ) {
                Icon(Icons.Default.AddCircle, "New exploit")
            }
        }

        Spacer(modifier = Modifier.height(20.dp))

        when (val tab = listTab[indexTabSelected.value]) {
            is StartTabComponent -> {
                StartExploitTab(
                    replaceCurrentTab = {
                        listTab[indexTabSelected.value] = component.createNewTab(it)
                    }
                )
            }
            is SqlmapTabComponent -> {
                SqlExploitTab(
                    startTaskRequest = tab.startRequestState,
                    response = tab.responseState,
                    status = tab.status,
                    onStartAttack = {
                        component.startAttack(indexTabSelected.value)
                    }
                )
            }
            is CommixTabComponent -> {
                CommixExploitTab(
                    commixRequest = tab.commixRequest,
                    startAttack = {
                        component.startAttack(indexTabSelected.value)
                    },
                    shellContent = tab.shellContent.asStateFlow().collectAsState(),
                    onSendCommand = {
                        tab.sendCommand(if (it.endsWith("\n")) it else "$it\n")
                    },
                    hasNewLine = tab.hasNewLine,
                    status = tab.status.collectAsState(),
                )
            }
            is TplmapTabComponent -> {
                TplmapExploitTab(
                    tplmapRequest = tab.tplmapRequest,
                    startAttack = {
                        component.startAttack(indexTabSelected.value)
                    },
                    shellContent = tab.shellContent.asStateFlow().collectAsState(),
                    onSendCommand = {
                        tab.sendCommand(if (it.endsWith("\n")) it else "$it\n")
                    },
                    hasNewLine = tab.hasNewLine,
                    status = tab.status.collectAsState()
                )
            }
            is LfiTabComponent -> {
                LfiExploitTab(
                    lfiRequest = tab.lfiRequest,
                    currentFile = tab.currentFile,
                    onChangeFile = {
                        component.startAttack(indexTabSelected.value)
                    },
                    onChangeOtherInfo = {
                        tab.resetTarget()
                        component.startAttack(indexTabSelected.value)
                    }
                )
            }
            is RfiTabComponent -> {
                RfiExploitTab(
                    rfiRequest = tab.rfiRequest,
                    response = tab.lastResponse,
                    execCommand = {
                        component.startAttack(indexTabSelected.value)
                    }
                )
            }
        }
    }

}

@Composable
fun StartExploitTab(
    replaceCurrentTab: (KClass<out ExploitTabComponent>) -> Unit
) {
    Column {

        Spacer(Modifier.padding(10.dp))

        OutlinedButton(
            onClick = {
                replaceCurrentTab(SqlmapTabComponent::class)
            },
            border = BorderStroke(1.dp, MaterialTheme.colors.primary),
            shape = RoundedCornerShape(50),
            colors = ButtonDefaults
                .outlinedButtonColors(
                    contentColor = MaterialTheme.colors.primary,
                )
        ) {
            Icon(Icons.Default.Add, "New exploit")
            Text(
                text = "New sqlmap exploit",
                style = typography.subtitle1
            )
        }

        Spacer(Modifier.padding(10.dp))

        OutlinedButton(
            onClick = {
                replaceCurrentTab(CommixTabComponent::class)
            },
            border = BorderStroke(1.dp, MaterialTheme.colors.primary),
            shape = RoundedCornerShape(50),
            colors = ButtonDefaults
                .outlinedButtonColors(
                    contentColor = MaterialTheme.colors.primary,
                )
        ) {
            Icon(Icons.Default.Add, "New exploit")
            Text(
                text = "New commix exploit",
                style = typography.subtitle1
            )
        }

        Spacer(Modifier.padding(10.dp))

        OutlinedButton(
            onClick = {
                replaceCurrentTab(TplmapTabComponent::class)
            },
            border = BorderStroke(1.dp, MaterialTheme.colors.primary),
            shape = RoundedCornerShape(50),
            colors = ButtonDefaults
                .outlinedButtonColors(
                    contentColor = MaterialTheme.colors.primary,
                )
        ) {
            Icon(Icons.Default.Add, "New exploit")
            Text(
                text = "New tplmap exploit",
                style = typography.subtitle1
            )
        }

        Spacer(Modifier.padding(10.dp))

        OutlinedButton(
            onClick = {
                replaceCurrentTab(LfiTabComponent::class)
            },
            border = BorderStroke(1.dp, MaterialTheme.colors.primary),
            shape = RoundedCornerShape(50),
            colors = ButtonDefaults
                .outlinedButtonColors(
                    contentColor = MaterialTheme.colors.primary,
                )
        ) {
            Icon(Icons.Default.Add, "New exploit")
            Text(
                text = "New LFI exploit",
                style = typography.subtitle1
            )
        }

        Spacer(Modifier.padding(10.dp))

        OutlinedButton(
            onClick = {
                replaceCurrentTab(RfiTabComponent::class)
            },
            border = BorderStroke(1.dp, MaterialTheme.colors.primary),
            shape = RoundedCornerShape(50),
            colors = ButtonDefaults
                .outlinedButtonColors(
                    contentColor = MaterialTheme.colors.primary,
                )
        ) {
            Icon(Icons.Default.Add, "New exploit")
            Text(
                text = "New RFI exploit",
                style = typography.subtitle1
            )
        }
    }
}
